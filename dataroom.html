<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Room â€“ DataRoom.ai</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
  <nav class="dash-nav">
    <div class="nav-inner">
      <a href="dashboard.html" class="logo">DataRoom<span>.ai</span></a>
      <div class="nav-right">
        <div class="user-menu" id="user-menu">
          <button class="user-menu-btn" id="user-menu-btn">
            <div class="avatar-small" id="nav-avatar"><span id="nav-initials"></span></div>
            <span id="nav-name"></span>
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 5L6 8L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          </button>
          <div class="user-dropdown" id="user-dropdown">
            <a href="dashboard.html">Dashboard</a>
            <a href="profile.html">My Profile</a>
            <a href="#" id="logout-btn">Log Out</a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="dashboard-main">
    <div class="dashboard-inner">

      <!-- Breadcrumb -->
      <div class="breadcrumb">
        <a href="dashboard.html">â† Dashboard</a>
        <span id="breadcrumb-name"></span>
      </div>

      <!-- Room Header -->
      <div class="room-header" id="room-header">
        <div class="room-logo" id="room-logo"></div>
        <div class="room-meta">
          <div class="room-title-row">
            <h1 id="room-title"></h1>
            <div class="room-badges">
              <span class="badge badge-role" id="room-role-badge"></span>
              <span class="badge badge-stage" id="room-stage-badge"></span>
            </div>
          </div>
          <p class="room-subtitle" id="room-subtitle"></p>
        </div>
      </div>

      <!-- Room Details -->
      <div class="room-details-grid" id="room-details"></div>

      <!-- Documents Section -->
      <div class="section-card" id="documents-section">
        <div class="section-header">
          <h2 class="section-title">Documents</h2>
          <button class="btn-add-doc" id="add-doc-btn" style="display:none;">+ Add Document</button>
        </div>

        <!-- Loading -->
        <div id="docs-loading" class="docs-loading">Loading documents...</div>

        <!-- Empty State -->
        <div class="docs-empty" id="docs-empty" style="display:none;">
          <div class="docs-empty-icon">ğŸ“„</div>
          <p class="docs-empty-title">No documents yet</p>
          <p class="docs-empty-sub">Upload your first document to get started</p>
          <button class="btn-upload-first" id="upload-first-btn">Upload First Document</button>
        </div>

        <!-- Document List -->
        <div id="docs-list" style="display:none;">
          <table class="docs-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Size</th>
                <th>Uploaded</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="docs-tbody"></tbody>
          </table>
        </div>

        <!-- Upload Error -->
        <div class="upload-error" id="upload-error" style="display:none;"></div>
      </div>

    </div>
  </main>

  <!-- Hidden file input -->
  <input type="file" id="file-input" accept=".pdf,.pptx,.docx,.xlsx,.png,.jpg,.jpeg" style="display:none;">

  <!-- Delete Confirm Modal -->
  <div class="modal-overlay" id="delete-modal" style="display:none;">
    <div class="modal-box">
      <h3 class="modal-title">Delete Document</h3>
      <p class="modal-body" id="delete-modal-body">Are you sure you want to delete this document? This cannot be undone.</p>
      <div class="modal-actions">
        <button class="btn-secondary" id="delete-cancel-btn">Cancel</button>
        <button class="btn-danger" id="delete-confirm-btn">Delete</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-config.js"></script>
  <script>
    var currentRoomId = null;
    var currentRoom = null;
    var pendingDeleteId = null;
    var pendingDeletePath = null;
    var pendingDeleteName = null;

    // â”€â”€ ALLOWED FILE TYPES & MAX SIZE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var ALLOWED_TYPES = [
      'application/pdf',
      'application/vnd.openxmlformats-officedocument.presentationml.presentation',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'image/png',
      'image/jpeg'
    ];
    var ALLOWED_EXTS = ['pdf','pptx','docx','xlsx','png','jpg','jpeg'];
    var MAX_SIZE = 25 * 1024 * 1024; // 25MB

    // â”€â”€ TYPE ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getTypeIcon(fileType, filename) {
      var ext = (filename || '').split('.').pop().toLowerCase();
      if (fileType.includes('pdf') || ext === 'pdf') return 'ğŸ“•';
      if (fileType.includes('presentation') || ext === 'pptx') return 'ğŸ“Š';
      if (fileType.includes('wordprocessing') || ext === 'docx') return 'ğŸ“';
      if (fileType.includes('spreadsheet') || ext === 'xlsx') return 'ğŸ“—';
      if (fileType.includes('image') || ext === 'png' || ext === 'jpg' || ext === 'jpeg') return 'ğŸ–¼ï¸';
      return 'ğŸ“„';
    }

    function getTypeLabel(fileType, filename) {
      var ext = (filename || '').split('.').pop().toUpperCase();
      return ext || 'FILE';
    }

    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function formatDate(iso) {
      var d = new Date(iso);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', async function() {
      var sessionRes = await auth.getSession();
      if (!sessionRes.session) { window.location.href = 'login.html'; return; }

      var user = sessionRes.session.user;
      var params = new URLSearchParams(window.location.search);
      currentRoomId = params.get('id');
      if (!currentRoomId) { window.location.href = 'dashboard.html'; return; }

      // Nav
      var profileRes = await profiles.getMyProfile();
      var p = profileRes.profile;
      var displayName = (p && p.display_name) ? p.display_name : (user.user_metadata && user.user_metadata.full_name) ? user.user_metadata.full_name : user.email;
      document.getElementById('nav-name').textContent = displayName;
      var initials = displayName.split(' ').map(function(w){ return w[0]; }).join('').toUpperCase().slice(0,2);
      document.getElementById('nav-initials').textContent = initials;
      if (p && p.avatar_url) {
        document.getElementById('nav-avatar').style.backgroundImage = 'url(' + p.avatar_url + ')';
        document.getElementById('nav-avatar').style.backgroundSize = 'cover';
        document.getElementById('nav-initials').style.display = 'none';
      }

      // Load room
      var roomRes = await dataRooms.getRoom(currentRoomId);
      if (roomRes.error || !roomRes.room) { window.location.href = 'dashboard.html'; return; }
      currentRoom = roomRes.room;
      renderRoom(currentRoom);

      // Load documents
      await loadDocuments();

      // Show add doc button
      document.getElementById('add-doc-btn').style.display = 'inline-flex';

      // Nav dropdown
      document.getElementById('user-menu-btn').addEventListener('click', function(e) {
        e.stopPropagation();
        document.getElementById('user-dropdown').classList.toggle('open');
      });
      document.addEventListener('click', function() {
        document.getElementById('user-dropdown').classList.remove('open');
      });

      // Logout
      document.getElementById('logout-btn').addEventListener('click', async function(e) {
        e.preventDefault();
        await auth.signOut();
        window.location.href = 'login.html';
      });

      // File input trigger
      document.getElementById('add-doc-btn').addEventListener('click', function() {
        document.getElementById('file-input').click();
      });
      document.getElementById('upload-first-btn').addEventListener('click', function() {
        document.getElementById('file-input').click();
      });
      document.getElementById('file-input').addEventListener('change', handleFileSelect);

      // Delete modal
      document.getElementById('delete-cancel-btn').addEventListener('click', closeDeleteModal);
      document.getElementById('delete-confirm-btn').addEventListener('click', confirmDelete);
      document.getElementById('delete-modal').addEventListener('click', function(e) {
        if (e.target === this) closeDeleteModal();
      });
    });

    // â”€â”€ RENDER ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderRoom(room) {
      document.title = room.company_name + ' â€“ DataRoom.ai';
      document.getElementById('breadcrumb-name').textContent = room.company_name;
      document.getElementById('room-title').textContent = room.company_name;

      var logoEl = document.getElementById('room-logo');
      if (room.logo_url) {
        logoEl.style.backgroundImage = 'url(' + room.logo_url + ')';
        logoEl.style.backgroundSize = 'cover';
      } else {
        logoEl.textContent = room.company_name.slice(0,2).toUpperCase();
      }

      if (room.owner_role) {
        var roleEl = document.getElementById('room-role-badge');
        roleEl.textContent = room.owner_role;
        roleEl.style.display = 'inline-block';
      }
      if (room.stage) {
        var stageEl = document.getElementById('room-stage-badge');
        stageEl.textContent = room.stage;
        stageEl.style.display = 'inline-block';
      }
      if (room.short_description) {
        document.getElementById('room-subtitle').textContent = room.short_description;
      }

      var details = [];
      if (room.short_description) details.push({ label: 'Description', value: room.short_description });
      if (room.website) details.push({ label: 'Website', value: '<a href="' + room.website + '" target="_blank">' + room.website + '</a>' });
      if (room.location) details.push({ label: 'Location', value: room.location });
      details.push({ label: 'Created', value: formatDate(room.created_at) });

      var grid = document.getElementById('room-details');
      grid.innerHTML = details.map(function(d) {
        return '<div class="detail-item"><span class="detail-label">' + d.label + '</span><span class="detail-value">' + d.value + '</span></div>';
      }).join('');
    }

    // â”€â”€ LOAD DOCUMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadDocuments() {
      document.getElementById('docs-loading').style.display = 'block';
      document.getElementById('docs-empty').style.display = 'none';
      document.getElementById('docs-list').style.display = 'none';

      var res = await documents.getDocuments(currentRoomId);
      document.getElementById('docs-loading').style.display = 'none';

      if (res.error) {
        document.getElementById('docs-empty').style.display = 'flex';
        return;
      }

      if (!res.documents || res.documents.length === 0) {
        document.getElementById('docs-empty').style.display = 'flex';
        return;
      }

      renderDocumentList(res.documents);
    }

    // â”€â”€ RENDER DOCUMENT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderDocumentList(docs) {
      var tbody = document.getElementById('docs-tbody');
      tbody.innerHTML = docs.map(function(doc) {
        return '<tr>' +
          '<td class="doc-name-cell">' +
            '<span class="doc-icon">' + getTypeIcon(doc.file_type, doc.original_filename) + '</span>' +
            '<span class="doc-name">' + escapeHtml(doc.original_filename) + '</span>' +
          '</td>' +
          '<td><span class="doc-type-badge">' + getTypeLabel(doc.file_type, doc.original_filename) + '</span></td>' +
          '<td class="doc-size">' + formatBytes(doc.file_size) + '</td>' +
          '<td class="doc-date">' + formatDate(doc.created_at) + '</td>' +
          '<td class="doc-actions">' +
            '<div class="doc-menu-wrapper">' +
              '<button class="doc-menu-btn" onclick="toggleDocMenu(this)" title="Options">â‹¯</button>' +
              '<div class="doc-menu-dropdown">' +
                '<button onclick="openDocument('' + doc.id + '','' + escapeAttr(doc.file_path) + '')">Open</button>' +
                '<button onclick="downloadDocument('' + doc.id + '','' + escapeAttr(doc.file_path) + '','' + escapeAttr(doc.original_filename) + '')">Download</button>' +
                '<button class="danger" onclick="promptDelete('' + doc.id + '','' + escapeAttr(doc.file_path) + '','' + escapeAttr(doc.original_filename) + '')">Delete</button>' +
              '</div>' +
            '</div>' +
          '</td>' +
        '</tr>';
      }).join('');

      document.getElementById('docs-list').style.display = 'block';
      document.getElementById('docs-empty').style.display = 'none';
    }

    // â”€â”€ FILE SELECT & UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function handleFileSelect(e) {
      var file = e.target.files[0];
      e.target.value = '';
      if (!file) return;

      var ext = file.name.split('.').pop().toLowerCase();
      var errorEl = document.getElementById('upload-error');
      errorEl.style.display = 'none';

      if (!ALLOWED_EXTS.includes(ext)) {
        errorEl.textContent = 'File type not allowed. Accepted: PDF, PPTX, DOCX, XLSX, PNG, JPG.';
        errorEl.style.display = 'block';
        return;
      }
      if (file.size > MAX_SIZE) {
        errorEl.textContent = 'File is too large. Maximum size is 25MB.';
        errorEl.style.display = 'block';
        return;
      }

      // Show uploading state
      var addBtn = document.getElementById('add-doc-btn');
      var firstBtn = document.getElementById('upload-first-btn');
      addBtn.textContent = 'Uploading...';
      addBtn.disabled = true;
      firstBtn.textContent = 'Uploading...';
      firstBtn.disabled = true;

      var res = await documents.uploadDocument(currentRoomId, file);

      addBtn.textContent = '+ Add Document';
      addBtn.disabled = false;
      firstBtn.textContent = 'Upload First Document';
      firstBtn.disabled = false;

      if (res.error) {
        errorEl.textContent = 'Upload failed: ' + res.error.message;
        errorEl.style.display = 'block';
        return;
      }

      await loadDocuments();
    }

    // â”€â”€ OPEN / DOWNLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function openDocument(docId, filePath) {
      closeAllDocMenus();
      var res = await documents.getSignedUrl(filePath);
      if (res.error || !res.url) { alert('Could not open document. Please try again.'); return; }
      window.open(res.url, '_blank');
    }

    async function downloadDocument(docId, filePath, filename) {
      closeAllDocMenus();
      var res = await documents.getSignedUrl(filePath);
      if (res.error || !res.url) { alert('Could not download document. Please try again.'); return; }
      var a = document.createElement('a');
      a.href = res.url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function promptDelete(docId, filePath, filename) {
      closeAllDocMenus();
      pendingDeleteId = docId;
      pendingDeletePath = filePath;
      pendingDeleteName = filename;
      document.getElementById('delete-modal-body').textContent = 'Are you sure you want to delete "' + filename + '"? This cannot be undone.';
      document.getElementById('delete-modal').style.display = 'flex';
    }

    function closeDeleteModal() {
      document.getElementById('delete-modal').style.display = 'none';
      pendingDeleteId = null;
      pendingDeletePath = null;
      pendingDeleteName = null;
    }

    async function confirmDelete() {
      if (!pendingDeleteId) return;
      var btn = document.getElementById('delete-confirm-btn');
      btn.textContent = 'Deleting...';
      btn.disabled = true;

      var res = await documents.deleteDocument(pendingDeleteId, pendingDeletePath, currentRoomId);
      btn.textContent = 'Delete';
      btn.disabled = false;
      closeDeleteModal();

      if (res.error) { alert('Delete failed: ' + res.error.message); return; }
      await loadDocuments();
    }

    // â”€â”€ DOC MENU HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleDocMenu(btn) {
      var wrapper = btn.closest('.doc-menu-wrapper');
      var isOpen = wrapper.classList.contains('open');
      closeAllDocMenus();
      if (!isOpen) wrapper.classList.add('open');
    }

    function closeAllDocMenus() {
      document.querySelectorAll('.doc-menu-wrapper.open').forEach(function(el) {
        el.classList.remove('open');
      });
    }

    document.addEventListener('click', function(e) {
      if (!e.target.closest('.doc-menu-wrapper')) closeAllDocMenus();
    });

    // â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function escapeHtml(str) {
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function escapeAttr(str) {
      return String(str).replace(/'/g,"\'").replace(/\\/g,'\\');
    }
  </script>
</body>
</html>
