<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Data Room – DataRoom.ai</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/dashboard.css">
  </head>
<body>
  <nav class="dash-nav">
      <div class="nav-inner">
            <a href="dashboard.html" class="logo">DataRoom<span>.ai</span></a>
          <div class="nav-right">
                <div class="user-menu" id="user-menu">
                        <button class="user-menu-btn" id="user-menu-btn">
                                  <div class="avatar-small" id="nav-avatar"><span id="nav-initials"></span></div>
                                  <span id="nav-name"></span>
                                  <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 5L6 8L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
                        </button>
                        <div class="user-dropdown" id="user-dropdown">
                                  <a href="dashboard.html">Dashboard</a>
                                  <a href="profile.html">My Profile</a>
                                  <a href="#" id="logout-btn">Log Out</a>
                        </div>
                </div>
          </div>
      </div>
  </nav>
<main class="dashboard-main">
  <div class="dashboard-inner">
  
      <!-- Breadcrumb -->
      <div class="breadcrumb">
            <a href="dashboard.html">&#8592; Dashboard</a>
            <span id="breadcrumb-name"></span>
      </div>
  
      <!-- Room Header -->
      <div class="room-header" id="room-header">
            <div class="room-logo" id="room-logo"></div>
            <div class="room-meta">
                    <div class="room-title-row">
                              <h1 id="room-title"></h1>
                              <div class="room-badges">
                                          <span class="badge badge-role" id="room-role-badge"></span>
                                          <span class="badge badge-stage" id="room-stage-badge"></span>
                              </div>
                    </div>
                    <p class="room-subtitle" id="room-subtitle"></p>
            </div>
      </div>
  
      <!-- Room Details -->
      <div class="room-details-grid" id="room-details"></div>
  
      <!-- Documents Section -->
      <div class="section-card" id="documents-section">
            <div class="section-header">
                    <h2 class="section-title">Documents</h2>
                    <button class="btn-add-doc" id="add-doc-btn" style="display:none;">+ Add Document</button>
            </div>
            <!-- Loading -->
            <div id="docs-loading" class="docs-loading">Loading documents...</div>
            <!-- Empty State -->
            <div class="docs-empty" id="docs-empty" style="display:none;">
                    <div class="docs-empty-icon">&#128196;</div>
                    <p class="docs-empty-title">No documents yet</p>
                    <p class="docs-empty-sub">Upload your first document to get started</p>
                    <button class="btn-upload-first" id="upload-first-btn">Upload First Document</button>
            </div>
            <!-- Document List -->
            <div id="docs-list" style="display:none;">
                    <table class="docs-table">
                              <thead>
                                            <tr>
                                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Size</th>
                                            <th>Uploaded</th>
                                            <th></th>
                                            </tr>
                              </thead>
                              <tbody id="docs-tbody"></tbody>
                    </table>
            </div>
            <!-- Upload Error -->
            <div class="upload-error" id="upload-error" style="display:none;"></div>
      </div>
  
  </div>
</main>

<!-- Hidden file input -->
<input type="file" id="file-input" accept=".pdf,.pptx,.docx,.xlsx,.png,.jpg,.jpeg" style="display:none;">

<!-- Delete Confirm Modal -->
<div class="modal-overlay" id="delete-modal" style="display:none;">
  <div class="modal-box">
      <h3 class="modal-title">Delete Document</h3>
      <p class="modal-body" id="delete-modal-body">Are you sure you want to delete this document? This cannot be undone.</p>
      <div class="modal-actions">
            <button class="btn-secondary" id="delete-cancel-btn">Cancel</button>
            <button class="btn-danger" id="delete-confirm-btn">Delete</button>
      </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-config.js"></script>
<script>
  var currentRoomId = null;
  var currentRoom   = null;
  var pendingDeleteId   = null;
  var pendingDeletePath = null;
  var pendingDeleteName = null;

  // ── ALLOWED FILE TYPES & MAX SIZE ────────────────────────────
  var ALLOWED_TYPES = [
      'application/pdf',
      'application/vnd.openxmlformats-officedocument.presentationml.presentation',
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'image/png',
      'image/jpeg'
    ];
  var ALLOWED_EXTS = ['pdf','pptx','docx','xlsx','png','jpg','jpeg'];
  var MAX_SIZE = 25 * 1024 * 1024; // 25 MB

  // ── TYPE ICONS ───────────────────────────────────────────────
  function getTypeIcon(fileType, filename) {
      var ext = (filename || '').split('.').pop().toLowerCase();
      if (fileType.includes('pdf')          || ext === 'pdf')  return '\uD83D\uDCD5';
      if (fileType.includes('presentation') || ext === 'pptx') return '\uD83D\uDCCA';
      if (fileType.includes('wordprocessing')|| ext === 'docx') return '\uD83D\uDCDD';
      if (fileType.includes('spreadsheet')  || ext === 'xlsx') return '\uD83D\uDCD7';
      if (fileType.includes('image') || ext === 'png' || ext === 'jpg' || ext === 'jpeg') return '\uD83D\uDDBC\uFE0F';
      return '\uD83D\uDCC4';
  }

  function getTypeLabel(fileType, filename) {
      var ext = (filename || '').split('.').pop().toUpperCase();
      return ext || 'FILE';
  }

  function formatBytes(bytes) {
      if (bytes < 1024)             return bytes + ' B';
      if (bytes < 1024 * 1024)     return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  function formatDate(iso) {
      var d = new Date(iso);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  // ── INIT ─────────────────────────────────────────────────────
  document.addEventListener('DOMContentLoaded', async function() {
      var sessionRes = await auth.getSession();
      if (!sessionRes.session) { window.location.href = 'login.html'; return; }
      var user = sessionRes.session.user;

      var params = new URLSearchParams(window.location.search);
      currentRoomId = params.get('id');
      if (!currentRoomId) { window.location.href = 'dashboard.html'; return; }

      // Nav
      var profileRes  = await profiles.getMyProfile();
      var p           = profileRes.profile;
      var displayName = (p && p.display_name)
        ? p.display_name
            : (user.user_metadata && user.user_metadata.full_name)
          ? user.user_metadata.full_name
              : user.email;

      document.getElementById('nav-name').textContent = displayName;
      var initials = displayName.split(' ').map(function(w){ return w[0]; }).join('').toUpperCase().slice(0,2);
      document.getElementById('nav-initials').textContent = initials;
      if (p && p.avatar_url) {
            document.getElementById('nav-avatar').style.backgroundImage = 'url(' + p.avatar_url + ')';
            document.getElementById('nav-avatar').style.backgroundSize  = 'cover';
            document.getElementById('nav-initials').style.display = 'none';
      }

      // ── FIX: getRoom returns { data, error } not { room, error } ──
      var roomRes = await dataRooms.getRoom(currentRoomId);
      if (roomRes.error || !roomRes.data) {
            window.location.href = 'dashboard.html';
            return;
      }
      currentRoom = roomRes.data;
      renderRoom(currentRoom);

      // Load documents
      await loadDocuments();

      // Show add-doc button
      document.getElementById('add-doc-btn').style.display = 'inline-flex';

      // Nav dropdown
      document.getElementById('user-menu-btn').addEventListener('click', function(e) {
            e.stopPropagation();
            document.getElementById('user-dropdown').classList.toggle('open');
      });
      document.addEventListener('click', function() {
            document.getElementById('user-dropdown').classList.remove('open');
      });

      // Logout
      document.getElementById('logout-btn').addEventListener('click', async function(e) {
            e.preventDefault();
            await auth.signOut();
            window.location.href = 'login.html';
      });

      // File input
      document.getElementById('add-doc-btn').addEventListener('click', function() {
            document.getElementById('file-input').click();
      });
      document.getElementById('upload-first-btn').addEventListener('click', function() {
            document.getElementById('file-input').click();
      });
      document.getElementById('file-input').addEventListener('change', handleFileSelect);

      // Delete modal
      document.getElementById('delete-cancel-btn').addEventListener('click', closeDeleteModal);
      document.getElementById('delete-confirm-btn').addEventListener('click', confirmDelete);
      document.getElementById('delete-modal').addEventListener('click', function(e) {
            if (e.target === this) closeDeleteModal();
      });
  });

  // ── RENDER ROOM ──────────────────────────────────────────────
  function renderRoom(room) {
      document.title = room.company_name + ' \u2013 DataRoom.ai';
      document.getElementById('breadcrumb-name').textContent = room.company_name;
      document.getElementById('room-title').textContent      = room.company_name;

      var logoEl = document.getElementById('room-logo');
      if (room.logo_url) {
            logoEl.style.backgroundImage = 'url(' + room.logo_url + ')';
            logoEl.style.backgroundSize  = 'cover';
      } else {
            logoEl.textContent = room.company_name.slice(0,2).toUpperCase();
      }

      if (room.owner_role) {
            var roleEl = document.getElementById('room-role-badge');
            roleEl.textContent     = room.owner_role;
            roleEl.style.display   = 'inline-block';
      }
      if (room.stage) {
            var stageEl = document.getElementById('room-stage-badge');
            stageEl.textContent   = room.stage;
            stageEl.style.display = 'inline-block';
      }
      if (room.short_description) {
            document.getElementById('room-subtitle').textContent = room.short_description;
      }

      var details = [];
      if (room.short_description) details.push({ label: 'Description', value: escapeHtml(room.short_description) });
      if (room.website)           details.push({ label: 'Website',     value: '<a href="' + escapeHtml(room.website) + '" target="_blank">' + escapeHtml(room.website) + '</a>' });
      if (room.location)          details.push({ label: 'Location',    value: escapeHtml(room.location) });
      details.push({ label: 'Created', value: formatDate(room.created_at) });

      document.getElementById('room-details').innerHTML = details.map(function(d) {
            return '<div class="detail-item"><span class="detail-label">' + d.label + '</span><span class="detail-value">' + d.value + '</span></div>';
      }).join('');
  }

  // ── LOAD DOCUMENTS ───────────────────────────────────────────
  async function loadDocuments() {
      document.getElementById('docs-loading').style.display = 'block';
      document.getElementById('docs-empty').style.display   = 'none';
      document.getElementById('docs-list').style.display    = 'none';

      var res = await documents.getDocuments(currentRoomId);
      document.getElementById('docs-loading').style.display = 'none';

      if (res.error) {
            document.getElementById('docs-empty').style.display = 'flex';
            return;
      }
      if (!res.documents || res.documents.length === 0) {
            document.getElementById('docs-empty').style.display = 'flex';
            return;
      }
      renderDocumentList(res.documents);
  }

  // ── RENDER DOCUMENT LIST ─────────────────────────────────────
  // ── FIX: use data-* attributes + addEventListener instead of
  //         inline onclick strings with fragile quote escaping ──
  function renderDocumentList(docs) {
      var tbody = document.getElementById('docs-tbody');
      tbody.innerHTML = docs.map(function(doc) {
            return '<tr>' +
                    '<td class="doc-name-cell">' +
                      '<span class="doc-icon">' + getTypeIcon(doc.file_type, doc.original_filename) + '</span>' +
                      '<span class="doc-name">'  + escapeHtml(doc.original_filename) + '</span>' +
                    '</td>' +
                    '<td><span class="doc-type-badge">' + getTypeLabel(doc.file_type, doc.original_filename) + '</span></td>' +
                    '<td class="doc-size">'  + formatBytes(doc.file_size) + '</td>' +
                    '<td class="doc-date">'  + formatDate(doc.created_at) + '</td>' +
                    '<td class="doc-actions">' +
                      '<div class="doc-menu-wrapper">' +
                        '<button class="doc-menu-btn" title="Options" data-doc-menu>&#8943;</button>' +
                        '<div class="doc-menu-dropdown">' +
                          '<button data-action="open"     data-doc-id="' + escapeAttr(doc.id)                  + '" data-file-path="' + escapeAttr(doc.file_path)        + '">Open</button>' +
                          '<button data-action="download" data-doc-id="' + escapeAttr(doc.id)                  + '" data-file-path="' + escapeAttr(doc.file_path)        + '" data-filename="' + escapeAttr(doc.original_filename) + '">Download</button>' +
                          '<button data-action="delete"   data-doc-id="' + escapeAttr(doc.id)                  + '" data-file-path="' + escapeAttr(doc.file_path)        + '" data-filename="' + escapeAttr(doc.original_filename) + '" class="danger">Delete</button>' +
                        '</div>' +
                      '</div>' +
                    '</td>' +
                  '</tr>';
      }).join('');

      // Attach delegated listeners
      var list = document.getElementById('docs-list');

      // Remove old delegated listener by cloning the node
      var newList = list.cloneNode(false);
      newList.appendChild(tbody.parentElement ? list.querySelector('table') : document.createElement('table'));
      // Simpler: just use the tbody directly
      tbody.addEventListener('click', handleDocTableClick);

      document.getElementById('docs-list').style.display = 'block';
      document.getElementById('docs-empty').style.display = 'none';
  }

  function handleDocTableClick(e) {
      var menuBtn = e.target.closest('[data-doc-menu]');
      var actionBtn = e.target.closest('[data-action]');

      if (menuBtn) {
            var wrapper = menuBtn.closest('.doc-menu-wrapper');
            var isOpen  = wrapper.classList.contains('open');
            closeAllDocMenus();
            if (!isOpen) wrapper.classList.add('open');
            return;
      }

      if (actionBtn) {
            var action   = actionBtn.dataset.action;
            var docId    = actionBtn.dataset.docId;
            var filePath = actionBtn.dataset.filePath;
            var filename = actionBtn.dataset.filename;
            closeAllDocMenus();
            if (action === 'open')     openDocument(docId, filePath);
            if (action === 'download') downloadDocument(docId, filePath, filename);
            if (action === 'delete')   promptDelete(docId, filePath, filename);
      }
  }

  // ── FILE SELECT & UPLOAD ─────────────────────────────────────
  async function handleFileSelect(e) {
      var file = e.target.files[0];
      e.target.value = '';
      if (!file) return;

      var ext     = file.name.split('.').pop().toLowerCase();
      var errorEl = document.getElementById('upload-error');
      errorEl.style.display = 'none';

      if (!ALLOWED_EXTS.includes(ext)) {
            errorEl.textContent  = 'File type not allowed. Accepted: PDF, PPTX, DOCX, XLSX, PNG, JPG.';
            errorEl.style.display = 'block';
            return;
      }
      if (file.size > MAX_SIZE) {
            errorEl.textContent  = 'File is too large. Maximum size is 25\u00A0MB.';
            errorEl.style.display = 'block';
            return;
      }

      var addBtn   = document.getElementById('add-doc-btn');
      var firstBtn = document.getElementById('upload-first-btn');
      addBtn.textContent   = 'Uploading\u2026';  addBtn.disabled   = true;
      firstBtn.textContent = 'Uploading\u2026';  firstBtn.disabled = true;

      var res = await documents.uploadDocument(currentRoomId, file);

      addBtn.textContent   = '+ Add Document';      addBtn.disabled   = false;
      firstBtn.textContent = 'Upload First Document'; firstBtn.disabled = false;

      if (res.error) {
            errorEl.textContent  = 'Upload failed: ' + res.error.message;
            errorEl.style.display = 'block';
            return;
      }
      await loadDocuments();
  }

  // ── OPEN / DOWNLOAD ──────────────────────────────────────────
  async function openDocument(docId, filePath) {
      var res = await documents.getSignedUrl(filePath);
      if (res.error || !res.url) { alert('Could not open document. Please try again.'); return; }
      window.open(res.url, '_blank');
  }

  async function downloadDocument(docId, filePath, filename) {
      var res = await documents.getSignedUrl(filePath);
      if (res.error || !res.url) { alert('Could not download document. Please try again.'); return; }
      var a = document.createElement('a');
      a.href = res.url; a.download = filename;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
  }

  // ── DELETE ───────────────────────────────────────────────────
  function promptDelete(docId, filePath, filename) {
      pendingDeleteId   = docId;
      pendingDeletePath = filePath;
      pendingDeleteName = filename;
      document.getElementById('delete-modal-body').textContent =
            'Are you sure you want to delete "' + filename + '"? This cannot be undone.';
      document.getElementById('delete-modal').style.display = 'flex';
  }

  function closeDeleteModal() {
      document.getElementById('delete-modal').style.display = 'none';
      pendingDeleteId   = null;
      pendingDeletePath = null;
      pendingDeleteName = null;
  }

  async function confirmDelete() {
      if (!pendingDeleteId) return;
      var btn = document.getElementById('delete-confirm-btn');
      btn.textContent = 'Deleting\u2026'; btn.disabled = true;
      var res = await documents.deleteDocument(pendingDeleteId, pendingDeletePath, currentRoomId);
      btn.textContent = 'Delete'; btn.disabled = false;
      closeDeleteModal();
      if (res.error) { alert('Delete failed: ' + res.error.message); return; }
      await loadDocuments();
  }

  // ── DOC MENU HELPERS ─────────────────────────────────────────
  function closeAllDocMenus() {
      document.querySelectorAll('.doc-menu-wrapper.open').forEach(function(el) {
            el.classList.remove('open');
      });
  }

  document.addEventListener('click', function(e) {
      if (!e.target.closest('.doc-menu-wrapper')) closeAllDocMenus();
  });

  // ── UTILS ────────────────────────────────────────────────────
  function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
  }

  function escapeAttr(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;');
  }
</script>
</body>
</html>
</script></th></th>
                                            </tr>
                              </thead></span>
</body></title>
  </head>
