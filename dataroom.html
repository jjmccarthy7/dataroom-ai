<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Room â€“ DataRoom.ai</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="stylesheet" href="css/dashboard.css">
</head>
<body>
<nav class="dash-nav">
  <div class="nav-inner">
    <a href="dashboard.html" class="logo">DataRoom<span>.ai</span></a>
    <div class="nav-right">
      <div class="user-menu" id="user-menu">
        <button class="user-menu-btn" id="user-menu-btn">
          <div class="avatar-small" id="nav-avatar"><span id="nav-initials"></span></div>
          <span id="nav-name"></span>
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 5L6 8L9 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>
        <div class="user-dropdown" id="user-dropdown">
          <a href="dashboard.html">Dashboard</a>
          <a href="profile.html">My Profile</a>
          <a href="#" id="logout-btn">Log Out</a>
        </div>
      </div>
    </div>
  </div>
</nav>
<main class="dashboard-main">
  <div class="dashboard-inner">
    <div class="breadcrumb">
      <a href="dashboard.html">&#8592; Dashboard</a>
      <span id="breadcrumb-name"></span>
    </div>
    <div class="room-header" id="room-header">
      <div class="room-logo" id="room-logo"></div>
      <div class="room-meta">
        <div class="room-title-row">
          <h1 id="room-title"></h1>
          <div class="room-badges">
            <span class="badge badge-role" id="room-role-badge"></span>
            <span class="badge badge-stage" id="room-stage-badge"></span>
            <span class="badge badge-viewer" id="viewer-badge" style="display:none;">&#128065; Viewer</span>
          </div>
        </div>
        <p class="room-subtitle" id="room-subtitle"></p>
      </div>
    </div>
    <div class="room-details-grid" id="room-details"></div>
    <div class="section-card" id="documents-section">
      <div class="section-header">
        <h2 class="section-title">Documents</h2>
        <div class="section-header-actions">
          <div class="add-doc-split" id="add-doc-split" style="display:none;">
            <button class="btn-add-doc-main" id="add-doc-main-btn">+ Add Document</button>
            <button class="btn-add-doc-arrow" id="add-doc-arrow-btn" aria-label="More options">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 4.5L6 7.5L9 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </button>
            <div class="add-doc-split-dropdown" id="add-doc-dropdown">
              <button id="opt-upload-file">
                <span class="split-icon">&#128196;</span>
                <span><span class="split-label">Upload File</span><span class="split-sub">PDF, PPTX, DOCX, XLSX&hellip;</span></span>
              </button>
              <button id="opt-add-link">
                <span class="split-icon">&#128279;</span>
                <span><span class="split-label">Paste a Link</span><span class="split-sub">Google Docs, Slides, Notion&hellip;</span></span>
              </button>
            </div>
          </div>
          <button class="btn-invite" id="invite-btn" style="display:none;">
            <svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="margin-right:5px;vertical-align:middle;"><path d="M9.5 7C10.88 7 12 5.88 12 4.5S10.88 2 9.5 2 7 3.12 7 4.5 8.12 7 9.5 7zm-5 0C5.88 7 7 5.88 7 4.5S5.88 2 4.5 2 2 3.12 2 4.5 3.12 7 4.5 7zm0 1.5C2.83 8.5 0 9.34 0 11v1h9v-1c0-1.66-2.83-2.5-4.5-2.5zm5 0c-.21 0-.44.01-.68.04C9.6 9.28 10.5 10.06 10.5 11v1H14v-1c0-1.66-2.83-2.5-4.5-2.5z" fill="currentColor"/></svg>
            Invite Investors
          </button>
        </div>
      </div>
      <div id="docs-loading" class="docs-loading">Loading documents...</div>
      <div class="docs-empty" id="docs-empty" style="display:none;">
        <div class="docs-empty-icon">&#128196;</div>
        <p class="docs-empty-title">No documents yet</p>
        <p class="docs-empty-sub" id="docs-empty-sub">Upload your first document to get started</p>
        <div id="empty-owner-actions" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
          <button class="btn-upload-first" id="upload-first-btn">&#128196; Upload File</button>
          <button class="btn-upload-first" id="link-first-btn" style="background:var(--green-mid);">&#128279; Paste a Link</button>
        </div>
      </div>
      <div id="docs-list" style="display:none;">
        <table class="docs-table">
          <thead><tr><th>Name</th><th>Type</th><th>Size</th><th>Uploaded</th><th></th></tr></thead>
          <tbody id="docs-tbody"></tbody>
        </table>
      </div>
      <div class="upload-error" id="upload-error" style="display:none;"></div>
    </div>
  </div>
</main>
<!-- Hidden file input -->
<input type="file" id="file-input" accept=".pdf,.pptx,.docx,.xlsx,.png,.jpg,.jpeg" style="display:none;">

<!-- Delete Modal -->
<div class="modal-overlay" id="delete-modal" style="display:none;">
  <div class="modal-box">
    <h3 class="modal-title">Delete Document</h3>
    <p class="modal-body" id="delete-modal-body">Are you sure?</p>
    <div class="modal-actions">
      <button class="btn-secondary" id="delete-cancel-btn">Cancel</button>
      <button class="btn-danger" id="delete-confirm-btn">Delete</button>
    </div>
  </div>
</div>

<!-- Add Link Modal -->
<div class="modal-overlay" id="link-modal" style="display:none;">
  <div class="modal-box">
    <button class="modal-close" id="link-modal-close-btn">&#10005;</button>
    <h2 class="modal-title">Paste a Document Link</h2>
    <p class="modal-subtitle">Add a Google Doc, Slides, Notion page, or any shareable URL.</p>
    <div class="link-modal-hint">
      <span class="link-modal-hint-icon">&#128161;</span>
      <span>Make sure the document is set to <strong>&ldquo;Anyone with the link can view&rdquo;</strong> before sharing.</span>
    </div>
    <div id="link-modal-error" class="modal-error" style="display:none;"></div>
    <div class="form-group">
      <label class="form-label" for="link-url-input">Document URL <span class="required">*</span></label>
      <input class="form-input" type="url" id="link-url-input" placeholder="https://docs.google.com/..." autocomplete="off">
    </div>
    <div class="form-group" style="margin-top:14px;">
      <label class="form-label" for="link-label-input">Label <span class="required">*</span></label>
      <input class="form-input" type="text" id="link-label-input" placeholder="e.g. Pitch Deck" maxlength="120" autocomplete="off">
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-secondary" id="link-modal-cancel-btn">Cancel</button>
      <button type="button" class="btn-primary" id="link-modal-submit-btn">Add Link</button>
    </div>
  </div>
</div>

<!-- Invite Modal -->
<div class="modal-overlay" id="invite-modal" style="display:none;">
  <div class="modal-box invite-modal-box">
    <button class="modal-close" id="invite-modal-close-btn">&#10005;</button>
    <h2 class="modal-title">Invite Investors</h2>
    <p class="modal-subtitle">Enter email addresses or @handles, separated by commas or new lines.</p>
    <div id="invite-modal-error" class="modal-error" style="display:none;"></div>
    <div class="form-group">
      <label class="form-label" for="invite-recipients-input">Recipients <span class="required">*</span></label>
      <textarea class="form-input invite-textarea" id="invite-recipients-input"
        placeholder="alice@example.com, bob@example.com&#10;@charlie"
        rows="4" autocomplete="off" spellcheck="false"></textarea>
      <p class="invite-hint">Accepts email addresses or @handles (with or without @).</p>
    </div>
    <div id="invite-results" style="display:none;"></div>
    <div class="modal-actions" id="invite-modal-actions">
      <button type="button" class="btn-secondary" id="invite-modal-cancel-btn">Cancel</button>
      <button type="button" class="btn-primary" id="invite-modal-submit-btn">Send Invites</button>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-config.js"></script>
<script>
var currentRoomId = null, currentRoom = null, currentIsOwner = false;
var pendingDeleteId = null, pendingDeletePath = null, pendingDeleteName = null;
var ALLOWED_EXTS = ['pdf','pptx','docx','xlsx','png','jpg','jpeg'];
var MAX_SIZE = 25*1024*1024;

function getTypeIcon(t,f){var e=(f||'').split('.').pop().toLowerCase();if(t.includes('pdf')||e==='pdf')return'ğŸ“•';if(t.includes('presentation')||e==='pptx')return'ğŸ“Š';if(t.includes('wordprocessing')||e==='docx')return'ğŸ“';if(t.includes('spreadsheet')||e==='xlsx')return'ğŸ“—';if(t.includes('image')||e==='png'||e==='jpg'||e==='jpeg')return'ğŸ–¼ï¸';return'ğŸ“„';}
function getTypeLabel(t,f){return((f||'').split('.').pop().toUpperCase()||'FILE');}
function formatBytes(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}
function formatDate(iso){var d=new Date(iso);return d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escapeAttr(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;');}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('DOMContentLoaded', async function() {
  var params = new URLSearchParams(window.location.search);
  currentRoomId = params.get('id');
  var inviteToken = params.get('invite');

  var sessionRes = await auth.getSession();
  if (!sessionRes.session) {
    var next = encodeURIComponent(window.location.pathname + window.location.search);
    window.location.href = 'login.html?next=' + next;
    return;
  }
  var user = sessionRes.session.user;
  if (!currentRoomId) { window.location.href = 'dashboard.html'; return; }

  // Accept invite token if present
  if (inviteToken) {
    await invites.acceptInvite(inviteToken);
    history.replaceState(null, '', window.location.pathname + '?id=' + currentRoomId);
  }

  // Nav
  var profileRes = await profiles.getMyProfile();
  var p = profileRes.profile;
  var displayName = (p && p.display_name) ? p.display_name : (user.user_metadata && user.user_metadata.full_name) ? user.user_metadata.full_name : user.email;
  document.getElementById('nav-name').textContent = displayName;
  var initials = displayName.split(' ').map(function(w){return w[0];}).join('').toUpperCase().slice(0,2);
  document.getElementById('nav-initials').textContent = initials;
  if (p && p.avatar_url) {
    document.getElementById('nav-avatar').style.backgroundImage = 'url('+p.avatar_url+')';
    document.getElementById('nav-avatar').style.backgroundSize = 'cover';
    document.getElementById('nav-initials').style.display = 'none';
  }

  var roomRes = await dataRooms.getRoom(currentRoomId);
  if (roomRes.error || !roomRes.data) { window.location.href = 'dashboard.html'; return; }
  currentRoom    = roomRes.data;
  currentIsOwner = roomRes.isOwner;

  renderRoom(currentRoom);
  await loadDocuments();
  applyRoleUI();

  document.getElementById('user-menu-btn').addEventListener('click', function(e){e.stopPropagation();document.getElementById('user-dropdown').classList.toggle('open');});
  document.addEventListener('click', function(){document.getElementById('user-dropdown').classList.remove('open');});
  document.getElementById('logout-btn').addEventListener('click', async function(e){e.preventDefault();await auth.signOut();window.location.href='login.html';});

  if (currentIsOwner) {
    document.getElementById('add-doc-main-btn').addEventListener('click', function(){document.getElementById('file-input').click();});
    document.getElementById('add-doc-arrow-btn').addEventListener('click', function(e){e.stopPropagation();document.getElementById('add-doc-split').classList.toggle('open');});
    document.getElementById('opt-upload-file').addEventListener('click', function(){document.getElementById('add-doc-split').classList.remove('open');document.getElementById('file-input').click();});
    document.getElementById('opt-add-link').addEventListener('click', function(){document.getElementById('add-doc-split').classList.remove('open');openLinkModal();});
    document.addEventListener('click', function(e){var s=document.getElementById('add-doc-split');if(s&&!s.contains(e.target))s.classList.remove('open');});
    document.getElementById('upload-first-btn').addEventListener('click', function(){document.getElementById('file-input').click();});
    document.getElementById('link-first-btn').addEventListener('click', openLinkModal);
    document.getElementById('file-input').addEventListener('change', handleFileSelect);
    document.getElementById('invite-btn').addEventListener('click', openInviteModal);
    document.getElementById('invite-modal-close-btn').addEventListener('click', closeInviteModal);
    document.getElementById('invite-modal-cancel-btn').addEventListener('click', closeInviteModal);
    document.getElementById('invite-modal-submit-btn').addEventListener('click', handleSendInvites);
    document.getElementById('invite-modal').addEventListener('click', function(e){if(e.target===this)closeInviteModal();});
  }
  document.getElementById('link-modal-close-btn').addEventListener('click', closeLinkModal);
  document.getElementById('link-modal-cancel-btn').addEventListener('click', closeLinkModal);
  document.getElementById('link-modal-submit-btn').addEventListener('click', handleAddLink);
  document.getElementById('link-modal').addEventListener('click', function(e){if(e.target===this)closeLinkModal();});
  document.getElementById('link-url-input').addEventListener('input', updateLinkPreview);
  document.getElementById('delete-cancel-btn').addEventListener('click', closeDeleteModal);
  document.getElementById('delete-confirm-btn').addEventListener('click', confirmDelete);
  document.getElementById('delete-modal').addEventListener('click', function(e){if(e.target===this)closeDeleteModal();});
});
</script>
<script>
// â”€â”€ ROLE UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyRoleUI() {
  if (currentIsOwner) {
    document.getElementById('add-doc-split').style.display = 'inline-flex';
    document.getElementById('invite-btn').style.display = 'inline-flex';
  } else {
    // Investor/viewer mode
    document.getElementById('viewer-badge').style.display = 'inline-block';
    document.getElementById('add-doc-split').style.display = 'none';
    document.getElementById('invite-btn').style.display = 'none';
    document.getElementById('empty-owner-actions').style.display = 'none';
    var sub = document.getElementById('docs-empty-sub');
    if (sub) sub.textContent = 'No documents have been shared yet.';
  }
}

// â”€â”€ RENDER ROOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRoom(room) {
  document.title = room.company_name + ' â€“ DataRoom.ai';
  document.getElementById('breadcrumb-name').textContent = room.company_name;
  document.getElementById('room-title').textContent = room.company_name;
  var logoEl = document.getElementById('room-logo');
  if (room.logo_url) {
    logoEl.style.backgroundImage = 'url(' + room.logo_url + ')';
    logoEl.style.backgroundSize = 'cover';
  } else {
    logoEl.textContent = room.company_name.slice(0,2).toUpperCase();
  }
  if (room.owner_role) {
    var r = document.getElementById('room-role-badge');
    r.textContent = room.owner_role; r.style.display = 'inline-block';
  }
  if (room.stage) {
    var s = document.getElementById('room-stage-badge');
    s.textContent = room.stage; s.style.display = 'inline-block';
  }
  if (room.short_description) document.getElementById('room-subtitle').textContent = room.short_description;
  var details = [];
  if (room.short_description) details.push({label:'Description', value:escapeHtml(room.short_description)});
  if (room.website) details.push({label:'Website', value:'<a href="'+escapeHtml(room.website)+'" target="_blank">'+escapeHtml(room.website)+'</a>'});
  if (room.location) details.push({label:'Location', value:escapeHtml(room.location)});
  details.push({label:'Created', value:formatDate(room.created_at)});
  document.getElementById('room-details').innerHTML = details.map(function(d){
    return '<div class="detail-item"><span class="detail-label">'+d.label+'</span><span class="detail-value">'+d.value+'</span></div>';
  }).join('');
}

// â”€â”€ LOAD DOCUMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDocuments() {
  document.getElementById('docs-loading').style.display = 'block';
  document.getElementById('docs-empty').style.display = 'none';
  document.getElementById('docs-list').style.display = 'none';
  var res = await documents.getDocuments(currentRoomId);
  document.getElementById('docs-loading').style.display = 'none';
  if (res.error || !res.documents || res.documents.length === 0) {
    document.getElementById('docs-empty').style.display = 'flex';
    return;
  }
  renderDocumentList(res.documents);
}

// â”€â”€ RENDER DOCUMENT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDocumentList(docs) {
  var tbody = document.getElementById('docs-tbody');
  tbody.innerHTML = docs.map(function(doc) {
    var isLink = (doc.source_type === 'link');
    var icon  = isLink ? 'ğŸ”—' : getTypeIcon(doc.file_type, doc.original_filename);
    var badge = isLink ? '<span class="doc-type-badge link-badge">LINK</span>' : '<span class="doc-type-badge">'+getTypeLabel(doc.file_type,doc.original_filename)+'</span>';
    var size  = isLink ? '<span style="color:var(--muted);font-size:12px;">&#8212;</span>' : formatBytes(doc.file_size);
    var actions;
    if (currentIsOwner) {
      if (isLink) {
        actions = '<div class="doc-menu-wrapper"><button class="doc-menu-btn" data-doc-menu>&#8943;</button><div class="doc-menu-dropdown"><button data-action="open-link" data-source-url="'+escapeAttr(doc.source_url||'')+'">Open Link</button><button data-action="delete" data-doc-id="'+escapeAttr(doc.id)+'" data-file-path="" data-filename="'+escapeAttr(doc.original_filename)+'" class="danger">Remove</button></div></div>';
      } else {
        actions = '<div class="doc-menu-wrapper"><button class="doc-menu-btn" data-doc-menu>&#8943;</button><div class="doc-menu-dropdown"><button data-action="open" data-doc-id="'+escapeAttr(doc.id)+'" data-file-path="'+escapeAttr(doc.file_path)+'">Open</button><button data-action="download" data-doc-id="'+escapeAttr(doc.id)+'" data-file-path="'+escapeAttr(doc.file_path)+'" data-filename="'+escapeAttr(doc.original_filename)+'">Download</button><button data-action="delete" data-doc-id="'+escapeAttr(doc.id)+'" data-file-path="'+escapeAttr(doc.file_path)+'" data-filename="'+escapeAttr(doc.original_filename)+'" class="danger">Delete</button></div></div>';
      }
    } else {
      // Investor: read-only â€” only show Open
      if (isLink) {
        actions = '<button class="btn-doc-open" data-action="open-link" data-source-url="'+escapeAttr(doc.source_url||'')+'">Open</button>';
      } else {
        actions = '<button class="btn-doc-open" data-action="open" data-doc-id="'+escapeAttr(doc.id)+'" data-file-path="'+escapeAttr(doc.file_path)+'">Open</button>';
      }
    }
    return '<tr><td class="doc-name-cell"><span class="doc-icon">'+icon+'</span><span class="doc-name">'+escapeHtml(doc.original_filename)+'</span></td><td>'+badge+'</td><td class="doc-size">'+size+'</td><td class="doc-date">'+formatDate(doc.created_at)+'</td><td class="doc-actions">'+actions+'</td></tr>';
  }).join('');
  tbody.addEventListener('click', handleDocTableClick);
  document.getElementById('docs-list').style.display = 'block';
  document.getElementById('docs-empty').style.display = 'none';
}

function handleDocTableClick(e) {
  var menuBtn   = e.target.closest('[data-doc-menu]');
  var actionBtn = e.target.closest('[data-action]');
  if (menuBtn) {
    var wrapper = menuBtn.closest('.doc-menu-wrapper');
    var isOpen  = wrapper.classList.contains('open');
    closeAllDocMenus();
    if (!isOpen) wrapper.classList.add('open');
    return;
  }
  if (actionBtn) {
    var action    = actionBtn.dataset.action;
    var docId     = actionBtn.dataset.docId;
    var filePath  = actionBtn.dataset.filePath;
    var filename  = actionBtn.dataset.filename;
    var sourceUrl = actionBtn.dataset.sourceUrl;
    closeAllDocMenus();
    if (action==='open')      openDocument(docId, filePath);
    if (action==='download')  downloadDocument(docId, filePath, filename);
    if (action==='open-link') window.open(sourceUrl,'_blank','noopener');
    if (action==='delete')    promptDelete(docId, filePath, filename);
  }
}
</script>
<script>
// â”€â”€ FILE SELECT & UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleFileSelect(e) {
  var file = e.target.files[0];
  e.target.value = '';
  if (!file) return;
  var ext = file.name.split('.').pop().toLowerCase();
  var errorEl = document.getElementById('upload-error');
  errorEl.style.display = 'none';
  if (!ALLOWED_EXTS.includes(ext)) { errorEl.textContent='File type not allowed. Accepted: PDF, PPTX, DOCX, XLSX, PNG, JPG.'; errorEl.style.display='block'; return; }
  if (file.size > MAX_SIZE) { errorEl.textContent='File is too large. Maximum size is 25Â MB.'; errorEl.style.display='block'; return; }
  var mainBtn  = document.getElementById('add-doc-main-btn');
  var firstBtn = document.getElementById('upload-first-btn');
  mainBtn.textContent='Uploadingâ€¦'; mainBtn.disabled=true;
  firstBtn.textContent='Uploadingâ€¦'; firstBtn.disabled=true;
  var res = await documents.uploadDocument(currentRoomId, file);
  mainBtn.textContent='+ Add Document'; mainBtn.disabled=false;
  firstBtn.textContent='Upload File'; firstBtn.disabled=false;
  if (res.error) { errorEl.textContent='Upload failed: '+res.error.message; errorEl.style.display='block'; return; }
  await loadDocuments();
}

async function openDocument(docId, filePath) {
  var res = await documents.getSignedUrl(filePath);
  if (res.error||!res.url) { alert('Could not open document.'); return; }
  window.open(res.url,'_blank');
}
async function downloadDocument(docId, filePath, filename) {
  var res = await documents.getSignedUrl(filePath);
  if (res.error||!res.url) { alert('Could not download document.'); return; }
  var a = document.createElement('a'); a.href=res.url; a.download=filename;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

// â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function promptDelete(docId, filePath, filename) {
  pendingDeleteId=docId; pendingDeletePath=filePath; pendingDeleteName=filename;
  document.getElementById('delete-modal-body').textContent = 'Are you sure you want to delete "'+filename+'"? This cannot be undone.';
  document.getElementById('delete-modal').style.display='flex';
}
function closeDeleteModal() {
  document.getElementById('delete-modal').style.display='none';
  pendingDeleteId=null; pendingDeletePath=null; pendingDeleteName=null;
}
async function confirmDelete() {
  if (!pendingDeleteId) return;
  var btn = document.getElementById('delete-confirm-btn');
  btn.textContent='Deletingâ€¦'; btn.disabled=true;
  var res = await documents.deleteDocument(pendingDeleteId, pendingDeletePath, currentRoomId);
  btn.textContent='Delete'; btn.disabled=false;
  closeDeleteModal();
  if (res.error) { alert('Delete failed: '+res.error.message); return; }
  await loadDocuments();
}

// â”€â”€ LINK MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isValidUrl(str) { try { var u=new URL(str); return u.protocol==='http:'||u.protocol==='https:'; } catch(_){return false;} }
function openLinkModal() {
  document.getElementById('link-url-input').value='';
  document.getElementById('link-label-input').value='';
  document.getElementById('link-modal-error').style.display='none';
  document.getElementById('link-modal').style.display='flex';
  document.getElementById('link-url-input').focus();
}
function closeLinkModal() { document.getElementById('link-modal').style.display='none'; }
function updateLinkPreview() {
  var urlVal = document.getElementById('link-url-input').value.trim();
  var labelInput = document.getElementById('link-label-input');
  if (urlVal && isValidUrl(urlVal) && !labelInput.value.trim()) {
    try {
      var path = new URL(urlVal).pathname;
      if (path.includes('/presentation/')) labelInput.placeholder='e.g. Pitch Deck';
      else if (path.includes('/document/')) labelInput.placeholder='e.g. Executive Summary';
      else if (path.includes('/spreadsheets/')) labelInput.placeholder='e.g. Financial Model';
    } catch(_){}
  }
}
async function handleAddLink() {
  var urlVal   = document.getElementById('link-url-input').value.trim();
  var labelVal = document.getElementById('link-label-input').value.trim();
  var errorEl  = document.getElementById('link-modal-error');
  errorEl.style.display='none';
  if (!urlVal) { errorEl.textContent='Please enter a document URL.'; errorEl.style.display='block'; return; }
  if (!isValidUrl(urlVal)) { errorEl.textContent='That doesnâ€™t look like a valid URL. Please include https://.'; errorEl.style.display='block'; return; }
  if (!labelVal) { errorEl.textContent='Please give this document a label.'; errorEl.style.display='block'; return; }
  var btn = document.getElementById('link-modal-submit-btn');
  btn.textContent='Addingâ€¦'; btn.disabled=true;
  var res = await documents.addLinkDocument(currentRoomId, labelVal, urlVal);
  btn.textContent='Add Link'; btn.disabled=false;
  if (res.error) { errorEl.textContent='Failed to add link: '+(res.error.message||res.error); errorEl.style.display='block'; return; }
  closeLinkModal();
  await loadDocuments();
}

// â”€â”€ DOC MENU HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function closeAllDocMenus() {
  document.querySelectorAll('.doc-menu-wrapper.open').forEach(function(el){el.classList.remove('open');});
}
document.addEventListener('click', function(e){if(!e.target.closest('.doc-menu-wrapper'))closeAllDocMenus();});
</script>
<script>
// â”€â”€ INVITE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openInviteModal() {
  document.getElementById('invite-recipients-input').value = '';
  document.getElementById('invite-modal-error').style.display = 'none';
  document.getElementById('invite-results').style.display = 'none';
  document.getElementById('invite-results').innerHTML = '';
  document.getElementById('invite-modal-actions').style.display = 'flex';
  document.getElementById('invite-modal-submit-btn').textContent = 'Send Invites';
  document.getElementById('invite-modal-submit-btn').disabled = false;
  document.getElementById('invite-modal').style.display = 'flex';
  document.getElementById('invite-recipients-input').focus();
}

function closeInviteModal() {
  document.getElementById('invite-modal').style.display = 'none';
}

function buildInviteLink(token) {
  return window.location.origin + '/dataroom.html?id=' + currentRoomId + '&invite=' + token;
}

async function handleSendInvites() {
  var rawInput = document.getElementById('invite-recipients-input').value.trim();
  var errorEl  = document.getElementById('invite-modal-error');
  errorEl.style.display = 'none';

  if (!rawInput) {
    errorEl.textContent = 'Please enter at least one email address or @handle.';
    errorEl.style.display = 'block';
    return;
  }

  var btn = document.getElementById('invite-modal-submit-btn');
  btn.textContent = 'Sendingâ€¦';
  btn.disabled = true;

  var res = await invites.inviteToRoom(currentRoomId, rawInput);

  btn.textContent = 'Send Invites';
  btn.disabled = false;

  if (res.error && !res.results) {
    errorEl.textContent = res.error;
    errorEl.style.display = 'block';
    return;
  }

  // Render per-recipient results
  var successCount = res.successCount;
  var results      = res.results || [];
  var resultsEl    = document.getElementById('invite-results');

  var html = '';

  if (successCount > 0) {
    html += '<div class="invite-success-banner">&#10003; Invited ' + successCount + ' ' + (successCount === 1 ? 'person' : 'people') + '</div>';
  }

  html += '<div class="invite-result-list">';
  results.forEach(function(r) {
    if (r.error) {
      html += '<div class="invite-result-row invite-result-error">'
            + '<span class="invite-result-icon">&#10005;</span>'
            + '<span class="invite-result-raw">' + escapeHtml(r.raw) + '</span>'
            + '<span class="invite-result-msg">' + escapeHtml(r.error) + '</span>'
            + '</div>';
    } else {
      var link = buildInviteLink(r.token);
      var label = r.alreadyInvited ? ' (already invited)' : '';
      html += '<div class="invite-result-row invite-result-ok">'
            + '<span class="invite-result-icon">&#10003;</span>'
            + '<span class="invite-result-email">' + escapeHtml(r.email) + escapeHtml(label) + '</span>'
            + '<button class="btn-copy-link" data-link="' + escapeAttr(link) + '" title="Copy invite link">&#128203; Copy link</button>'
            + '</div>';
    }
  });
  html += '</div>';

  resultsEl.innerHTML = html;
  resultsEl.style.display = 'block';

  // Wire copy buttons
  resultsEl.querySelectorAll('.btn-copy-link').forEach(function(btn) {
    btn.addEventListener('click', function() {
      navigator.clipboard.writeText(btn.dataset.link).then(function() {
        btn.textContent = 'âœ“ Copied!';
        setTimeout(function(){ btn.innerHTML = '&#128203; Copy link'; }, 2000);
      });
    });
  });

  // Change footer to just "Done" after results shown
  document.getElementById('invite-modal-submit-btn').style.display = 'none';
  document.getElementById('invite-modal-cancel-btn').textContent = 'Done';
}
</script>
</body>
</html>
